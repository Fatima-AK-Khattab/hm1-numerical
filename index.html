<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„ÙˆØ§Ø¬Ø¨ Ø§Ù„Ø¨ÙŠØªÙŠ Ø§Ù„Ø£ÙˆÙ„</title>
    
    <!-- Ù…ÙƒØªØ¨Ø© Ø§Ù„ØªØµÙ…ÙŠÙ… -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Ù…ÙƒØªØ¨Ø§Øª React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Ø§Ù„Ù…ØªØ±Ø¬Ù… Ù„ÙŠØ¹Ù…Ù„ Ø§Ù„ÙƒÙˆØ¯ ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­ -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-gray-50 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // ==========================================
        // ğŸ”´ Ø¶Ø¹ÙŠ Ø±Ø§Ø¨Ø· Google Apps Script Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù‡Ù†Ø§ Ø¨ÙŠÙ† Ø¹Ù„Ø§Ù…ØªÙŠ Ø§Ù„ØªÙ†ØµÙŠØµ
        // ==========================================
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz7mf_Nb_hOwlyvK5AyMiPxN5Xw3LmimB17Ief4RxCkHJgUdVwVoWkTjfazLiehiT3Q0g/exec";
        
        // ==========================================

        const getRandomInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

        const getDeterminant = (matrix) => {
            const n = matrix.length;
            if (n === 1) return matrix[0][0];
            if (n === 2) return matrix[0][0] * matrix[1][1] - matrix[0][1] * matrix[1][0];
            let det = 0;
            for (let c = 0; c < n; c++) {
                const subMatrix = matrix.slice(1).map(row => row.filter((_, j) => j !== c));
                det += (c % 2 === 0 ? 1 : -1) * matrix[0][c] * getDeterminant(subMatrix);
            }
            return det;
        };

        const generateSystem = () => {
            let det = 0; let A = [];
            while (det === 0) {
                A = [[getRandomInt(-4, 4), getRandomInt(-4, 4), getRandomInt(-4, 4)],
                     [getRandomInt(-4, 4), getRandomInt(-4, 4), getRandomInt(-4, 4)],
                     [getRandomInt(-4, 4), getRandomInt(-4, 4), getRandomInt(-4, 4)]];
                det = getDeterminant(A);
            }
            const X = [getRandomInt(-4, 4), getRandomInt(-4, 4), getRandomInt(-4, 4)];
            const B = [
                A[0][0] * X[0] + A[0][1] * X[1] + A[0][2] * X[2],
                A[1][0] * X[0] + A[1][1] * X[1] + A[1][2] * X[2],
                A[2][0] * X[0] + A[2][1] * X[1] + A[2][2] * X[2]
            ];
            return { A, B, X, det };
        };

        const generateMatrix5x5 = () => {
            let matrix = []; let det = 0;
            while (det === 0) {
                matrix = Array.from({ length: 5 }, () => Array.from({ length: 5 }, () => getRandomInt(-4, 4)));
                det = getDeterminant(matrix);
            }
            return { A: matrix, det };
        };

        const formatTerm = (coeff, varName, isFirst) => {
            if (coeff === 0) return "";
            let sign = coeff > 0 ? (isFirst ? "" : "+ ") : "- ";
            let absCoeff = Math.abs(coeff);
            let numStr = absCoeff === 1 ? "" : absCoeff;
            return `${sign}${numStr}${varName} `;
        };

        const formatEq = (a, b, c, rhs) => {
            let terms = [];
            if (a !== 0) terms.push(formatTerm(a, "x", terms.length === 0));
            if (b !== 0) terms.push(formatTerm(b, "y", terms.length === 0));
            if (c !== 0) terms.push(formatTerm(c, "z", terms.length === 0));
            if (terms.length === 0) return `0 = ${rhs}`;
            let eq = terms.join("").replace(/\s+/g, ' ').trim();
            if (eq.startsWith("+ ")) eq = eq.substring(2);
            return `${eq} = ${rhs}`;
        };

        const compressImage = (file, callback) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = event => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 400; 
                    const scaleSize = MAX_WIDTH / img.width;
                    canvas.width = MAX_WIDTH;
                    canvas.height = img.height * scaleSize;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    callback(canvas.toDataURL('image/jpeg', 0.4));
                }
            }
        };

        function App() {
            const [view, setView] = useState('login');
            const [studentInfo, setStudentInfo] = useState({ name: '', studyType: 'ØµØ¨Ø§Ø­ÙŠ' });
            const [questions, setQuestions] = useState([]);
            const [currentQIndex, setCurrentQIndex] = useState(0);
            const [answers, setAnswers] = useState({});
            const [errorMsg, setErrorMsg] = useState('');
            const [isSubmitting, setIsSubmitting] = useState(false);

            const handleStart = (e) => {
                e.preventDefault();
                if (GOOGLE_SCRIPT_URL === "Ø¶Ø¹_Ø±Ø§Ø¨Ø·_Ø³ÙƒØ±Ø¨Øª_Ø¬ÙˆØ¬Ù„_Ø§Ù„Ø¬Ø¯ÙŠØ¯_Ù‡Ù†Ø§" || !GOOGLE_SCRIPT_URL.startsWith("https://script.google.com")) {
                    setErrorMsg('Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… ÙˆØ¶Ø¹ Ø±Ø§Ø¨Ø· Ø¬ÙˆØ¬Ù„ Ø§Ù„Ø³ÙƒØ±Ø¨Øª Ø§Ù„ØµØ­ÙŠØ­ ÙÙŠ Ø§Ù„ÙƒÙˆØ¯.');
                    return;
                }
                const sName = studentInfo.name.trim();
                if (sName.split(' ').length < 2) {
                    setErrorMsg('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­.');
                    return;
                }
                if (localStorage.getItem(`hw1_${sName}_${studentInfo.studyType}`)) {
                    setErrorMsg('Ù„Ù‚Ø¯ Ù‚Ù…Øª Ø¨ØªØ³Ù„ÙŠÙ… Ø§Ù„ÙˆØ§Ø¬Ø¨ Ù…Ø³Ø¨Ù‚Ø§Ù‹.');
                    return;
                }
                setErrorMsg('');
                setQuestions([
                    { ...generateSystem(), type: 'system', title: 'Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø£ÙˆÙ„ (Ø£)', method: 'Cramer Rule' },
                    { ...generateSystem(), type: 'system', title: 'Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø£ÙˆÙ„ (Ø¨)', method: 'Gauss Elimination' },
                    { ...generateSystem(), type: 'system', title: 'Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø£ÙˆÙ„ (Ø¬)', method: 'Inverse Matrix' },
                    { ...generateMatrix5x5(), type: 'det5x5', title: 'Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø«Ø§Ù†ÙŠ', method: 'Reduction Formula' }
                ]);
                setAnswers({});
                setCurrentQIndex(0);
                setView('quiz');
            };

            const handleAnswerChange = (field, value) => {
                setAnswers(prev => ({ ...prev, [currentQIndex]: { ...prev[currentQIndex], [field]: value } }));
            };

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    compressImage(file, (base64Str) => {
                        handleAnswerChange('image', base64Str);
                        handleAnswerChange('fileName', file.name);
                    });
                }
            };

            const validateCurrentQuestion = () => {
                const ans = answers[currentQIndex];
                if (!ans || !ans.image) { setErrorMsg('ÙŠØ¬Ø¨ Ø¥Ø±ÙØ§Ù‚ ØµÙˆØ±Ø© Ø§Ù„Ø­Ù„ Ø§Ù„ÙŠØ¯ÙˆÙŠ.'); return false; }
                const q = questions[currentQIndex];
                if (q.type === 'system') {
                    if (!ans.x || !ans.y || !ans.z) { setErrorMsg('ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ù‚ÙŠÙ… x, y, z.'); return false; }
                } else {
                    if (!ans.det) { setErrorMsg('ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯.'); return false; }
                }
                setErrorMsg('');
                return true;
            };

            const handleSubmit = async () => {
                if (!validateCurrentQuestion()) return;
                setIsSubmitting(true);
                let totalScore = 0; const scores = []; const studentAnswers = [];
                let finalImageBase64 = answers[0]?.image || ''; 

                questions.forEach((q, idx) => {
                    const ans = answers[idx];
                    let score = 0; let submittedAnswer = "";
                    if (q.type === 'system') {
                        submittedAnswer = `x=${ans.x}, y=${ans.y}, z=${ans.z}`;
                        if (parseInt(ans.x) === q.X[0] && parseInt(ans.y) === q.X[1] && parseInt(ans.z) === q.X[2]) score = 2.5;
                    } else {
                        submittedAnswer = `det=${ans.det}`;
                        if (parseInt(ans.det) === q.det) score = 2.5;
                    }
                    totalScore += score; scores.push(score); studentAnswers.push(submittedAnswer);
                });

                try {
                    const response = await fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify({
                            name: studentInfo.name, studyType: studentInfo.studyType,
                            scores: scores, studentAnswers: studentAnswers, totalScore: totalScore,
                            image: finalImageBase64, date: new Date().toLocaleString('en-US', { timeZone: 'Asia/Baghdad' })
                        }),
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' }
                    });
                    
                    const result = await response.json();
                    if (result.status === 'success') {
                        localStorage.setItem(`hw1_${studentInfo.name.trim()}_${studentInfo.studyType}`, 'true');
                        setView('success');
                    } else {
                        throw new Error(result.message);
                    }
                } catch (e) {
                    console.error(e);
                    setErrorMsg('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: ØªØ£ÙƒØ¯ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø¬ÙˆØ¬Ù„ (Anyone) ÙˆÙ…Ù† Ø§ØªØµØ§Ù„Ùƒ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.');
                } finally {
                    setIsSubmitting(false);
                }
            };

            if (view === 'login') {
                return (
                    <div className="min-h-screen flex items-center justify-center p-4">
                        <div className="bg-white rounded-xl shadow-lg p-8 max-w-md w-full border-t-4 border-blue-600">
                            <div className="text-center mb-8">
                                <h1 className="text-2xl font-bold text-gray-800 mb-2">Ø§Ù„ÙˆØ§Ø¬Ø¨ Ø§Ù„Ø¨ÙŠØªÙŠ Ø§Ù„Ø£ÙˆÙ„ (1)</h1>
                                <p className="text-gray-500">Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¹Ø¯Ø¯ÙŠ</p>
                            </div>
                            <form onSubmit={handleStart} className="space-y-6">
                                <div>
                                    <label className="block text-sm font-bold text-gray-700 mb-2">Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ Ù„Ù„Ø·Ø§Ù„Ø¨</label>
                                    <input type="text" required placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ø§Ù„ÙƒØ§Ù…Ù„" className="w-full p-3 border rounded-lg" value={studentInfo.name} onChange={e => setStudentInfo({...studentInfo, name: e.target.value})} />
                                </div>
                                <div>
                                    <label className="block text-sm font-bold text-gray-700 mb-2">Ù†ÙˆØ¹ Ø§Ù„Ø¯Ø±Ø§Ø³Ø©</label>
                                    <select className="w-full p-3 border rounded-lg" value={studentInfo.studyType} onChange={e => setStudentInfo({...studentInfo, studyType: e.target.value})}>
                                        <option value="ØµØ¨Ø§Ø­ÙŠ">ØµØ¨Ø§Ø­ÙŠ</option><option value="Ù…Ø³Ø§Ø¦ÙŠ">Ù…Ø³Ø§Ø¦ÙŠ</option>
                                    </select>
                                </div>
                                {errorMsg && <p className="text-red-600 bg-red-50 p-3 rounded-lg text-sm font-bold text-center">{errorMsg}</p>}
                                <button type="submit" className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg">Ø¨Ø¯Ø¡ Ø§Ù„ÙˆØ§Ø¬Ø¨</button>
                            </form>
                        </div>
                    </div>
                );
            }

            if (view === 'quiz') {
                const q = questions[currentQIndex];
                const ans = answers[currentQIndex] || {};
                return (
                    <div className="min-h-screen flex items-center justify-center p-4 py-10">
                        <div className="bg-white rounded-xl shadow-lg p-6 md:p-10 max-w-2xl w-full">
                            <div className="flex justify-between items-center mb-6 border-b pb-4">
                                <h2 className="text-xl font-bold text-gray-800">{q.title}</h2>
                                <span className="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-bold">Ø³Ø¤Ø§Ù„ {currentQIndex + 1} / 4</span>
                            </div>
                            <div className="mb-6 bg-blue-50 p-6 rounded-lg border">
                                <p className="text-lg font-bold text-blue-700 mb-4" dir="ltr">{q.method}</p>
                                <div className="flex flex-col items-center justify-center text-xl font-mono overflow-x-auto" dir="ltr">
                                    {q.type === 'system' ? (
                                        <>{q.A.map((row, i) => <p key={i} className="whitespace-nowrap">{formatEq(row[0], row[1], row[2], q.B[i])}</p>)}</>
                                    ) : (
                                        <div className="flex items-center text-lg md:text-xl">
                                            <span className="text-4xl font-light">|</span>
                                            <div className="grid grid-cols-5 gap-3 text-center mx-2">{q.A.map(r => r.map((v, i) => <span key={i} className="w-6">{v}</span>))}</div>
                                            <span className="text-4xl font-light">|</span>
                                        </div>
                                    )}
                                </div>
                            </div>
                            
                            <div className="space-y-4">
                                <div className="bg-gray-50 p-4 rounded-lg border">
                                    <h4 className="font-bold mb-3">Ø§Ù„Ù†ÙˆØ§ØªØ¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©:</h4>
                                    {q.type === 'system' ? (
                                        <div className="grid grid-cols-3 gap-2" dir="ltr">
                                            <input type="number" placeholder="x =" className="p-2 border rounded w-full" value={ans.x||''} onChange={e=>handleAnswerChange('x', e.target.value)} />
                                            <input type="number" placeholder="y =" className="p-2 border rounded w-full" value={ans.y||''} onChange={e=>handleAnswerChange('y', e.target.value)} />
                                            <input type="number" placeholder="z =" className="p-2 border rounded w-full" value={ans.z||''} onChange={e=>handleAnswerChange('z', e.target.value)} />
                                        </div>
                                    ) : (
                                        <input type="number" placeholder="Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯ =" className="p-2 border rounded w-full text-center" value={ans.det||''} onChange={e=>handleAnswerChange('det', e.target.value)} dir="ltr"/>
                                    )}
                                </div>

                                <div className="bg-white p-4 rounded-lg border-2 border-dashed border-gray-300 text-center">
                                    <p className="font-bold text-gray-700 mb-2">Ø¥Ø±ÙØ§Ù‚ ØµÙˆØ±Ø© Ø§Ù„Ø­Ù„ (Ø¥Ø¬Ø¨Ø§Ø±ÙŠ)</p>
                                    <input type="file" accept="image/*" className="hidden" id="fileUp" onChange={handleFileUpload} />
                                    <label htmlFor="fileUp" className="cursor-pointer bg-blue-50 text-blue-700 px-4 py-2 rounded-lg inline-block font-bold">ğŸ“¸ Ø§Ø®ØªØ± ØµÙˆØ±Ø©</label>
                                    {ans.fileName && <p className="mt-2 text-green-600 font-bold">âœ… ØªÙ… Ø¥Ø±ÙØ§Ù‚ Ø§Ù„ØµÙˆØ±Ø©</p>}
                                </div>
                            </div>

                            {errorMsg && <div className="mt-4 p-3 bg-red-100 text-red-700 rounded font-bold text-center">{errorMsg}</div>}

                            <div className="mt-6 flex justify-between">
                                <button onClick={()=>{setErrorMsg(''); setCurrentQIndex(p=>p-1)}} disabled={currentQIndex===0 || isSubmitting} className="px-4 py-2 bg-gray-200 rounded font-bold">Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
                                {currentQIndex < 3 ? (
                                    <button onClick={()=>{if(validateCurrentQuestion()) setCurrentQIndex(p=>p+1)}} className="px-6 py-2 bg-blue-600 text-white rounded font-bold">Ø§Ù„ØªØ§Ù„ÙŠ</button>
                                ) : (
                                    <button onClick={handleSubmit} disabled={isSubmitting} className="px-6 py-2 bg-green-600 text-white rounded font-bold">{isSubmitting ? 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...' : 'ØªØ³Ù„ÙŠÙ… Ø§Ù„ÙˆØ§Ø¬Ø¨'}</button>
                                )}
                            </div>
                        </div>
                    </div>
                );
            }

            if (view === 'success') {
                return (
                    <div className="min-h-screen flex items-center justify-center p-4">
                        <div className="bg-white rounded-xl shadow-lg p-10 max-w-md text-center border-t-4 border-green-500">
                            <div className="text-6xl mb-4">âœ…</div>
                            <h2 className="text-2xl font-bold mb-4">ØªÙ… ØªØ³Ù„ÙŠÙ… Ø§Ù„ÙˆØ§Ø¬Ø¨ Ø¨Ù†Ø¬Ø§Ø­</h2>
                            <p className="text-gray-600">Ø´ÙƒØ±Ø§Ù‹ Ù„ÙƒØŒ ØªÙ… Ø­ÙØ¸ Ø¥Ø¬Ø§Ø¨Ø§ØªÙƒ Ø¹Ù†Ø¯ Ø§Ù„Ù…Ø¹Ù„Ù….</p>
                        </div>
                    </div>
                );
            }

            return null;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
